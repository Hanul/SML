SML.Bridge=METHOD(t=>{let n=require("path"),e=(t,n)=>{t({statusCode:500,content:'<!doctype html><html><head><meta charset="UTF-8"><title>'+n+"</title></head><body>Error</body></html>",contentType:"text/html"})},i=t=>{t({statusCode:404,content:'<!doctype html><html><head><meta charset="UTF-8"><title>Page not found.</title></head><body><p><b>Page not found.</b></p></body></html>',contentType:"text/html"})};return{run:t=>{let o=t.rootPath;return{notExistsHandler:(t,n,e)=>{i(e)},requestListener:(t,u,r,s)=>{let c,d,m=t.uri;return run=(()=>{SML.Load(c,{notExists:()=>{i(u)},error:t=>{e(u,t)},success:t=>{u({content:t,contentType:"text/html"})}})}),NEXT([t=>{""===m?CHECK_FILE_EXISTS(o+"/index.sml",n=>{m=n===!0?"index.sml":"index.html",t()}):t()},()=>{return()=>{c=o+"/"+m,d=n.extname(m).toLowerCase(),".sml"===d?run():""===d?NEXT([t=>{CHECK_FILE_EXISTS(c+".sml",n=>{n===!0?CHECK_IS_FOLDER(c+".sml",n=>{n===!0?t():(c+=".sml",run())}):t()})},()=>{return()=>{CHECK_FILE_EXISTS(c,t=>{t===!0?CHECK_IS_FOLDER(c,t=>{t===!0?(c+="/index.sml",run()):s()}):s()})}}]):s()}}]),!1}}}}}),SML.Compile=METHOD(()=>{let t=(n,e,i)=>{let o,u,r,s="",c="",d=0,m=n=>{let u,r,d=0,m="",f="",a=[];if(EACH(n,t=>{return"\t"===t&&void(d+=1)}),""!==n.trim())if(d===e){if(n=n.trim(),"#"!==n[0]&&(""!==c?void 0!==o?(s+=">\n"+t(c,e+1,i),c="",REPEAT(e+i+1,()=>{s+="\t"}),s+="</"+o+">\n",o=void 0):(s+=t(c,e+1,i-1),c="",REPEAT(e+i-1,()=>{s+="\t"})):void 0!==o&&"'"!==o&&"`"!==o&&(s+="meta"===o||"link"===o||"br"===o?">\n":"></"+o+">\n"),REPEAT(e+i+1,()=>{s+="\t"}),"'"===n[0]?(o="'",u=n):"`"===n[0]?(o="`",u=n):(o="",EACH(n,(t,e)=>{return" "===t||"\t"===t?(u=n.substring(e),!1):void("#"===t||"."===t?(""!==f&&(a.push(f),f=""),r=t):"#"===r?m+=t:"."===r?f+=t:o+=t)}),""!==f&&(a.push(f),f=""),s+="<"+o),a.length>0&&(u=" class='"+RUN(()=>{let t="";return EACH(a,(n,e)=>{e>0&&(t+=" "),t+=n}),t})+"'"+(void 0===u?"":u)),""!==m&&(u=" id='"+m+"'"+(void 0===u?"":u)),void 0!==u)){let t,n,i="",r="",c="",d=0;EACH(u,(s,m)=>{n!==!0&&"'"===s&&"\\"!==u[m-1]?t===!0?(""===c.trim()?r+=RUN(()=>{let t=u.substring(d+1,m),n="",i=e+1;return EACH(t,(o,u)=>{i!==-1&&("\t"===o?(i+=1,i===e+2&&(i=-1)):i=-1),i===-1&&("\r"===o||"\\"===o&&"'"===t[u+1]||("\n"===o?(n+="\n",i=e+1):n+=o))}),n}):"meta"===o?(c=c.trim(),c=c.substring(0,c.length-1),i+=' name="'+c+'" content="'+u.substring(d+1,m)+'"'):i+=c+'"'+u.substring(d+1,m)+'"',c="",t=!1):t=!0:t!==!0&&"`"===s&&"\\"!==u[m-1]?n===!0?(""===c.trim()&&(r+=u.substring(d+1,m).replace(/\\`/g,"`")),c="",n=!1):n=!0:t!==!0&&n!==!0&&(c+=s,d=m+1)}),t!==!0&&n!==!0||SHOW_ERROR("[SML] 문자열 구문이 아직 끝나지 않았습니다.",u),""===r?s+=i:(s+="'"===o||"`"===o?r+"\n":i+">"+r+"</"+o+">\n",o=void 0)}}else c+=n+"\n"};return EACH(n,(t,e)=>{r!==!0&&"'"===t&&"\\"!==n[e-1]?u=u!==!0:u!==!0&&"`"===t&&"\\"!==n[e-1]?r=r!==!0:u!==!0&&r!==!0&&"\n"===t&&(m(n.substring(d,e)),d=e+1)}),u===!0||r===!0?SHOW_ERROR("[SML] 문자열 구문이 아직 끝나지 않았습니다.",n.substring(d)):m(n.substring(d)),""!==c?void 0!==o?(s+=">\n"+t(c,e+1,i),REPEAT(e+i+1,()=>{s+="\t"}),s+="</"+o+">\n",o=void 0):(s+=t(c,e+1,i-1),REPEAT(e+i-1,()=>{s+="\t"})):void 0!==o&&"'"!==o&&"`"!==o&&(s+="meta"===o||"link"===o||"br"===o?">\n":"></"+o+">\n"),s};return{run:n=>{let e,i,o=n.indexOf("body");return"\n"!==n[o+4]||0!==o&&"\n"!==n[o-1]?(e="",i="\t<body>\n"+t(n,0,1)+"\t</body>\n"):(e=t(n.substring(0,o),0,1),i=t(n.substring(o),0,0)),'<!doctype html>\n<html>\n\t<head>\n\t\t<meta charset="UTF-8">\n'+e+"\t</head>\n"+i+"</html>"}}}),SML.Load=METHOD(t=>{let n={};return{run:(t,e)=>{let i=e.notExists,o=e.error,u=e.success;GET_FILE_INFO(t,{notExists:i,success:e=>{let r=n[t];void 0!==r&&(void 0!==e.lastUpdateTime&&r.lastUpdateTime.getTime()===e.lastUpdateTime.getTime()||void 0!==e.createTime&&r.lastUpdateTime.getTime()===e.createTime.getTime())?u(r.html):READ_FILE(t,{notExists:i,error:o,success:i=>{let o=SML.Compile(i.toString());n[t]={lastUpdateTime:void 0===e.lastUpdateTime?e.createTime:e.lastUpdateTime,html:o},u(o)}})}})}}});